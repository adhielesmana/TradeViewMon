# Trady - Stock Market Prediction Platform

## Overview
Trady is a full-stack financial application providing real-time stock market data monitoring and AI-powered price predictions. It is designed for traders and financial analysts to make informed decisions through actionable insights into market movements, generated by continuously fetching market data, employing ensemble machine learning models for short-term price predictions, and tracking prediction accuracy. The platform aims to offer a reliable and sophisticated tool for navigating financial markets.

## User Preferences
Preferred communication style: Simple, everyday language.

### Database Sync Protocol
1. **Migrations**: All structural changes (tables/columns) MUST be added to `deploy/migrations/init_database.sql`.
2. **Idempotency**: Use `IF NOT EXISTS` for tables, columns, and indexes.
3. **Extensions**: Ensure `CREATE EXTENSION IF NOT EXISTS pgcrypto;` is at the top of the SQL file to support `gen_random_uuid()`.
4. **Environment**: Use `DATABASE_URL` for all database connections. Avoid relying on local unix sockets or specific system roles (like "trady") in deployment scripts.
5. **Syncing**: The `init_database.sql` script is executed on every deployment to ensure dev and prod databases are identical.
6. **Self-Hosted**: The `deploy.sh` script uses `POSTGRES_USER` and `POSTGRES_DB` from `.env` for migrations. If you encounter "role does not exist" errors, either reset the volume (`docker compose down -v`) or update `.env` to match existing credentials.

## System Architecture

### Frontend
- **Framework**: React 18+ with TypeScript (Vite).
- **UI**: Shadcn/ui (Radix UI + Tailwind CSS) for a professional trading platform aesthetic.
- **State Management**: TanStack Query for server state with aggressive caching (30-60 sec refetch).
- **Routing**: Wouter for lightweight client-side routing across pages like Live Market, Predictions, AI Suggestions, and Backtesting.
- **Design System**: Inter (UI) and JetBrains Mono (numerical data) fonts, semantic colors for financial data, dark/light theme, responsive grid layouts.

### Backend
- **Runtime**: Node.js with Express.js.
- **API**: RESTful endpoints (`/api/market/*`, `/api/market/status`, `/api/predictions/*`, etc.) with JSON responses.
- **Real-Time Updates**: WebSocket for per-symbol updates (market, prediction, accuracy).
- **Scheduler**: Node-cron (every 60 seconds) for market data fetching, candle generation, prediction, and accuracy calculation.
- **Market Hours Detection**: Manages API calls based on market hours for Forex/Metals (Sunday 5PM - Friday 5PM EST) and 24/7 for Crypto, generating offline candles during closure.
- **Unified Signal Generator**: Centralizes BUY/SELL/HOLD signals using weighted scoring from various technical indicators (EMA, RSI, MACD, Stochastic, Price Trend, Candlestick Patterns) with strict decision thresholds (netScore > 40 for BUY, < -40 for SELL).
- **Prediction Engine**: Ensemble model combining Moving Average, Linear Regression, and multi-factor technical analysis, outputting predicted price, direction, confidence, and analysis breakdown.
- **AI Trading Analyzer**: GPT-5-nano (or fallback to technicals) for trade validation, integrating prediction model accuracy with 6 technical indicators to generate signals with strict low-risk conditions.
- **News Service**: RSS feed integration (configurable via Settings, default: Yahoo Finance) with OpenAI analysis to generate market predictions based on news sentiment, key factors, affected symbols, and trading recommendations. Features AI analysis caching (`news_analysis_snapshots` table) for fast page loads with background refresh when cache is stale (10+ minutes). Includes Article History feature with paginated browsing of past predictions and auto-generated 4-paragraph professional market analysis articles stored in `generatedArticle` column. **Automatic image extraction** from RSS feeds using media:content, media:thumbnail, enclosure, and HTML img tags - images are stored per article (`imageUrl` column) and propagated to snapshots for unique featured images per analysis.
- **Enhanced Hourly AI Analysis**: Runs every hour at minute 0 (plus initial run 30 seconds after startup) to perform deep market analysis:
  - Reads FULL article content from the last 1 hour (not just RSS summaries)
  - Incorporates last 14 days of stored AI predictions as supplemental context for trend analysis
  - Stores results with `sourceArticles`, `historicalContext`, and `analysisType` fields for traceability
  - Keeps last 336 hourly snapshots (14 days of data) for historical analysis
- **Market Data Service**: Multi-source price verification system:
  - BTCUSD: Finnhub (BINANCE:BTCUSDT) primary, Gold-API fallback
  - XAUUSD/XAGUSD: Gold-API primary, Yahoo Finance futures (GC=F, SI=F) verification
  - Stocks: Finnhub (GDX, SPY, USO) or Yahoo Finance (.JK suffix for Indonesian)
  - On-demand historical data seeding and simulated data for unsupported symbols (US10Y)
- **Risk Manager**: Comprehensive risk management service (`server/risk-manager.ts`) enforcing:
  - **Daily Loss Limit**: Maximum 3% of account balance or $500 per day
  - **Consecutive Loss Halt**: Trading pauses after 3 consecutive losing trades
  - **Position Limits**: Maximum 2 concurrent open positions, max 5% of balance per trade
  - **Confidence Validation**: Requires AI confidence ≥75% AND technical confidence ≥60%
  - All limits are configurable via RiskLimits interface

### Auto-Trade Safety Pipeline
Every auto-trade must pass through 5 mandatory validation gates (in order):
1. **Risk Status Check**: Blocks if daily loss exceeded, consecutive losses hit limit, or max positions reached
2. **R:R Ratio Check**: Minimum 1.5:1 risk-reward ratio required
3. **Technical Confidence**: Minimum 60% confidence from technical analysis
4. **MANDATORY AI Validation**: OpenAI must approve with:
   - shouldTrade = true
   - riskLevel = "LOW" (only LOW risk trades allowed)
   - Direction agreement with technical signal
   - AI confidence ≥75%
5. **Position Size Validation**: Trade size within 5% of account balance

### Database
- **ORM**: Drizzle ORM with PostgreSQL (Neon serverless).
- **Schema**:
    1.  `market_data`: OHLCV candles (symbol, timestamp, OHLCV, interval).
    2.  `predictions`: AI-generated predictions (timestamp, target, predicted price/direction, model, confidence).
    3.  `accuracy_results`: Prediction validation (actual vs. predicted, difference, match flag).
    4.  `system_status`: Component health monitoring.
    5.  `price_state`: Price continuity (symbol, last open/close, timestamp).
    6.  `app_settings`: Encrypted application configuration and API keys.
    7.  `symbol_categories`: Dynamic category management (name, displayOrder, isActive) with CRUD API at `/api/settings/categories`.
    8.  `monitored_symbols`: Database-driven symbol management with name, category, currency, enabled status.
    9.  `news_analysis_snapshots`: Cached AI market predictions for fast News & AI Analysis page loads.

### Symbol & Currency Management
- **Database-Driven Symbols**: All symbols are managed via `monitored_symbols` table with `/api/market/symbols` endpoint.
- **Currency Formatting**: Currency (IDR/USD) is determined exclusively from `SymbolInfo.currency` field, no hardcoded symbol lists.
- **Symbol Context**: React context provides `currentSymbol` (SymbolInfo) derived from API data via useMemo for fresh metadata.
- **Fallback Behavior**: Uses hardcoded FALLBACK_SYMBOLS only when database is empty; preserves stored symbol during initial load.
- **Price Formatting**: `formatPrice(price, symbolInfo)` and `getCurrencySymbol(symbolInfo)` functions use SymbolInfo objects.
- **Indonesian Stock Auto-Detection**: Symbols with "(IDX)" in displayName OR currency = "IDR" are automatically:
  - Category set to "stocks" and currency to "IDR"
  - Registered with market data service for Yahoo Finance (.JK suffix)
  - Loaded from database on server startup for persistence across restarts

### Session & Authentication
- **Session Management**: express-session with memorystore (in-memory) or connect-pg-simple (PostgreSQL).
- **Authentication**: Passport.js local strategy (bcrypt-hashed passwords), session-based with 24-hour expiry.
- **Supported Instruments**: Managed via database `monitored_symbols` table (configurable in Settings).

## External Dependencies

### Third-Party APIs
- **Gold-API.com**: Real-time spot prices for XAU, XAG, BTC.
- **Finnhub**: Real-time stock/ETF prices for GDX, GDXJ, NEM, SPX, DXY, USOIL (requires API key).
- **OpenAI**: GPT-5-nano for AI-enhanced trading analysis (configurable via UI settings).

### Database
- **PostgreSQL**: Via Neon Serverless.

### UI Component Libraries
- **Radix UI**: Headless accessible components.
- **Recharts**: Chart rendering.
- **Lucide React**: Icon system.
- **date-fns**: Date formatting.

### Development Tools
- **Vite**: Frontend build tool.
- **ESBuild**: Server-side bundling.
- **TypeScript**: Type safety.
- **Tailwind CSS**: Styling.

### Utility Libraries
- **simple-statistics**: Statistical calculations.
- **node-cron**: Scheduled job execution.
- **zod**: Runtime schema validation.
- **class-variance-authority**: Component variant management.
- **wouter**: Lightweight routing.

## Docker Deployment

### Timezone Synchronization
All Docker containers (app, database) sync their timezone with the host system:
- **Host mounts**: `/etc/localtime` and `/etc/timezone` mounted read-only to all containers
- **Environment variables**: `TZ` set for app container, `TZ` and `PGTZ` set for PostgreSQL
- **Default timezone**: Asia/Jakarta (configurable via `TZ` in `.env`)
- **Timezone package**: `tzdata` installed in the app container for proper timezone handling

### Docker Auto-Cleanup
Automatic cleanup of unused Docker images older than 7 days:
- **Script**: `deploy/docker-cleanup.sh` - removes dangling images, unused images older than 7 days, and build cache
- **Systemd timer**: Runs daily at 3 AM with automatic retry
- **Fallback**: Cron job for systems without systemd
- **Installation**: Automatically configured during deployment via `deploy.sh`
- **Manual install**: Run `sudo deploy/install-cleanup-timer.sh` if needed
- **Logs**: `/var/log/docker-cleanup.log` or `journalctl -u docker-cleanup.service`

### Deployment Commands
```bash
# Full deployment
./deploy/deploy.sh --domain yourdomain.com --email admin@yourdomain.com

# Quick redeploy (uses saved config)
./deploy/deploy.sh

# Manual Docker cleanup
./deploy/docker-cleanup.sh

# Check cleanup timer status
systemctl status docker-cleanup.timer
```